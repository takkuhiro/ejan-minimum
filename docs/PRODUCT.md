# Ejan ~あなたに最適なメイクアップを提案します~

### 概要

- アップロードされた顔写真に対して、最適なメイクアップ（ヘアスタイル＋メイク）を施すWebアプリケーション
- このアプリケーションはユーザーに、なりたい自分の顔になる手順を伝授します。
- 具体的には完成イメージ写真をユーザーが選択すると、その手順を写真や動画を使って提示します。
- 男性、女性を最初に選択してもらい、その人の顔にあったおすすめ画像が自動で生成されることで、イメージが簡単に沸きます。
- 例えば、男性の場合だと前髪上げやセンターパートなどの髪型、色白にしたり眉毛を整えたりといったメイクの要望も自由自在です。

### 作成する画面とユーザー体験

1. ウェルカムページ: 性別を選択し、自分の顔写真をアップロードする
    - 性別は「男性」「女性」「中性的」の3つから選択できる
    - 画像は10MBまでアップロード可能
    - アップロードされた画像はGoogle Cloud Storageに保存される
    - 裏側での処理: アップロードされた画像から３パターンのメイクアップスタイルを生成する
        - 画像生成は、Cloud Functionsでnano bananaを呼び出して生成する
        - nano bananaではその顔写真を入力として、メイクアップスタイル画像の生成とそれに至るまでのメイクアップ手順を生成する
            - 入力: アップロード画像 + 事前に用意してあるプロンプト
            - 出力: 生成画像 + メイクアップ手順（プレーンテキスト）
        - メイクアップ手順はプレーンテキストになっているので、geminiのStructured Outputで要素に分解する
            - 入力: メイクアップ手順
            - 出力: メイクアップタイトル, メイクアップ説明文, メイクアップ手順のステップ(番号付き箇条書き), 必要な道具
        - この結果、メイクアップ３パターンが獲得されることになる
        - 生成が完了するまでは「生成中...」と表示する

2. スタイル選択ページ: 生成されたおすすめスタイルから好みのものを選択する
    - アップロードされた顔写真と、生成された３パターンのメイクアップスタイル画像を表示する
    - ユーザーはその中から自分が気に入ったスタイルを選択する
    - もし気に入ったスタイルがなければ「カスタマイズ」を選択する（カスタマイズボタンはメイクアップ画像と同じ大きさでグレー背景で真ん中に+アイコンが表示されている）

3. スタイル調整ページ: 細かな調整が可能
    - 選択されたスタイルの詳細 (完成形の画像、そのスタイルの説明文、そのスタイルの構築方法、必要な道具)を表示する
    - 画面下部にテキストボックスを表示し、「もっとこうして」という指示を出せる。指示を書いて「生成する」ボタンを押すと修正内容が適用された顔写真が生成される。説明文や構築方法なども新たに作成されたものが表示される。
    - 「カスタマイズ」を選択した場合も基本的なUIは変わらず、自分のアップロード画像とテキストボックスを表示し、そこに自由にユーザーが指示をかけるようにする。そして「調整する」ボタンを押すと顔写真が生成され、既存の画面が新しく作成された画像や説明文などに設定されたものが表示される。
    - 上記のいずれの場合も、画像生成AIとしてNano Bananaを用いて実行する
    - 最後に「これで決まり」ボタンを押すと、それで希望するスタイルが確定する

4. 生成中ローディングページ: 生成中であることを表示
    - 前の手順でスタイルが確定されると、それに対する大規模な処理が生成開始されるため、ローディング画面をユーザーに表示する。「この処理には完了までに3分ほどかかります。画面を更新せず、そのままでお待ちください」と表示する。
    - webからapiにポーリングを行い、状態を取得する
    - まずその生成画像にするためのメイクアップ手順がすでに手順2で獲得されている（もしくは手順3で修正orカスタマイズで1から生成したものが獲得されている）
    - それを元にJSONモードでLLMを使って詳細なステップに分割する。
        - ステップごとに、(1)ステップ名, (2)所要時間, (3)説明文（コツ）が記載されている。
    - そして、ステップごとにそのステップの完成イメージ画像と、そのステップ解説動画を生成する
        - ステップの完成イメージ画像: nano bananaで生成する
        - ステップの解説動画: 前stepの完成イメージ画像とstepの手順テキストを入力として、動画生成AIであるVeo3を用いて動画を生成する
    - 全てのリソースは生成したらGoogle Cloud Storageに格納する。全ての処理が完了したら、DBのstatusを更新する。

5. 完成した手順書の表示
    - ユーザーはステップごとに以下の情報を確認できる
        - ステップ名
        - ステップ解説動画
        - ステップ完成イメージ画像
        - ステップ所用時間
        - ステップ説明文
    - いずれのステップでもステップ一覧、「Next」ボタン、「Back」ボタンがある。

### 開発上の注意点
- デモ用のプロダクトを最小構成で作成する。
    - apps/web: TypeScript + React / Cloud Run
    - apps/api: Python + FastAPI / Cloud Run
    - apps/functions/image_generation: 画像生成AIモデル実行 (Nano Banana) / Python / Cloud Function
    - apps/functions/video_generation: 動画生成AIモデル実行 (Veo3) / Python / Cloud Function
- 追加のインフラ
    - Cloud Storage: アップロード画像、生成画像、生成動画の保存場所
    - (必要であれば) Cloud SQL（リレーショナルデータの保存場所）
    - (必要であれば) その他のインフラ
- 以下のAIモデルをそれぞれ個別のCloud Functionで使用する
    - 画像生成モデル
        - gemini-2.5-flash-image-preview (Nano Banana)
        - サンプル実装: apps/api/samples/image_generation_with_nano_banana.py
        - Nano Bananaによる画像生成の実行に関するドキュメント: https://ai.google.dev/gemini-api/docs/image-generation?hl=ja
    - 動画生成モデル
        - veo-3.0-generate-001
        - サンプル実装: apps/api/samples/video_generation_with_veo3.py
        - 10秒ごとに動画生成ステータスを確認するポーリングも1つのCloud Function内で行う (デモ用なので並列実行数も限られていると想定)
        - Veo3による動画生成の実行に関するドキュメント: https://ai.google.dev/gemini-api/docs/video?hl=ja&example=dialogue
- apps/web以下にはモックデータを用いたサンプルアプリを実装している。
    - これをベースとしつつ、モックデータを実際のデータに置き換えて実装すること
    - 実装上修正した方が良い点があれば適宜修正すること
- インフラはGoogle Cloudを利用し、Terraformを用いて管理すること。
- インフラに関する操作はユーザー自身がコマンドを実行するため、勝手に実行せず、ユーザーに実行を促すこと。
- ファイルの削除などの操作はユーザーが行うため、勝手に実行せず、ユーザーに実行を促すこと。
- 次のような機能はデモで必要ないので実装しないようにする。
    - ログイン機能
    - 認証機能
    - お気に入り機能
    - キューイング
    - Rate Limitなどのミドルウェア

### ターゲットユーザー

- これまでメイクや髪型のセットなどをやったことがないため、自信がないが、このアプリケーションを通じて生まれ変わりたい人
- ヘアスタイルやメイクが好きだが、毎回同じようなメイクアップになっているため、もっと色々な選択肢を広げて人生を豊かにしたい人
