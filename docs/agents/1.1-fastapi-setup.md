# FastAPI初期セットアップ

## 概要
FastAPIを使用したEjan APIバックエンドの初期セットアップを実装しました。このドキュメントでは、エントリーポイント、環境変数管理、CORS設定、エラーハンドリング、ヘルスチェックエンドポイントの実装内容を記録します。

## 実装詳細

### ディレクトリ構造
```
apps/api/
├── app/
│   ├── __init__.py           # パッケージ初期化
│   ├── main.py               # FastAPIアプリケーションエントリーポイント
│   └── core/
│       ├── __init__.py
│       └── config.py         # 環境変数と設定管理
├── tests/
│   ├── unit/                 # ユニットテスト
│   │   └── test_config.py
│   └── integration/          # 統合テスト
│       └── test_app_setup.py
├── .env                      # 環境変数（git ignoreする）
├── .env.example              # 環境変数テンプレート
├── mypy.ini                  # mypy設定
├── pytest.ini                # pytest設定
└── pyproject.toml            # プロジェクト設定
```

### 主要コンポーネント

#### 1. 設定管理（app/core/config.py）
- Pydantic Settingsを使用した型安全な環境変数管理
- 必須設定: `GOOGLE_API_KEY`, `PROJECT_ID`, `STORAGE_BUCKET`
- 開発/本番環境の切り替え対応
- CORSオリジンの動的設定（文字列またはリスト形式）

#### 2. FastAPIアプリケーション（app/main.py）
- Lifespan Context Managerによる起動/終了処理
- CORSミドルウェアの設定（フロントエンド localhost:3000 を許可）
- グローバル例外ハンドラーの実装
  - HTTPException: 標準HTTPエラー
  - ValidationError: Pydanticバリデーションエラー
  - Exception: 予期しないエラー
- ヘルスチェックエンドポイント（GET /health）

### TDD実装プロセス
1. **RED Phase**: 失敗するテストを先に作成
   - 12個のテスト（ユニット5個、統合7個）を作成
   - すべてのテストが失敗することを確認

2. **GREEN Phase**: 最小限のコードでテストをパス
   - 設定クラスとFastAPIアプリケーションを実装
   - すべてのテストがパスすることを確認

3. **REFACTOR Phase**: コードの品質向上
   - Deprecation warningの修正（on_event → lifespan）
   - Black, Ruff, Mypyによる品質チェック
   - 型注釈の追加と改善

## 設定項目

### 環境変数（.env）
```env
# Google API設定
GOOGLE_API_KEY=your-google-api-key-here
PROJECT_ID=ejan-demo-project
STORAGE_BUCKET=ejan-demo-storage

# アプリケーション環境
ENV=development

# CORS設定
CORS_ORIGINS=http://localhost:3000

# サーバー設定
HOST=0.0.0.0
PORT=8000
```

## エラー対処

### 遭遇した問題
1. **CORS origins パース エラー**
   - 原因: Pydantic v2でのリスト型フィールドの扱いの変更
   - 解決: field_validatorでカスタムパース処理を実装

2. **Deprecation warning**
   - 原因: FastAPIの新バージョンでon_eventが非推奨に
   - 解決: Lifespan context managerに移行

3. **Mypy型エラー**
   - 原因: 環境変数から読み込む必須フィールドの型チェック
   - 解決: type: ignore コメントと適切な型注釈を追加

## テスト結果
- すべてのテスト（12個）がパス
- コードカバレッジ: 該当部分100%
- 品質チェック: Black、Ruff、Mypyすべてパス

## 実行コマンド

### 開発サーバー起動
```bash
cd apps/api
uv run uvicorn app.main:app --reload --port 8000
```

### テスト実行
```bash
cd apps/api
uv run pytest tests/ -v
```

### 品質チェック
```bash
cd apps/api
uv run black app/
uv run ruff check app/
uv run mypy app/ --config-file mypy.ini
```

## 改善点
1. ロギング設定の拡張（構造化ログ、ログレベル管理）
2. メトリクス収集の追加（Prometheus形式）
3. OpenAPI仕様のカスタマイズ（タグ、説明の充実）
4. 環境別設定ファイルの分離

## 開発者が実行する必要があること

### 1. 初期セットアップ
```bash
# プロジェクトディレクトリに移動
cd apps/api

# Python環境の初期化（uvを使用）
uv init  # 初回のみ

# 依存関係のインストール
uv add fastapi uvicorn python-dotenv pydantic-settings

# 開発用ツールのインストール
uv add --dev pytest pytest-asyncio httpx pytest-mock black ruff mypy
```

### 2. 環境変数の設定
```bash
# .env.exampleから.envファイルを作成
cp .env.example .env

# .envファイルを編集して実際の値を設定
# 必須項目:
# - GOOGLE_API_KEY: Google APIキー（Gemini/Nano Banana/Veo3用）
# - PROJECT_ID: GCPプロジェクトID
# - STORAGE_BUCKET: Cloud Storageバケット名
```

### 3. 開発サーバーの起動
```bash
# uvicornでサーバーを起動（自動リロード付き）
uv run uvicorn app.main:app --reload --port 8000
```

## 動作検証方法

### 1. ヘルスチェックエンドポイントの確認
```bash
# curlでヘルスチェック
curl http://localhost:8000/health

# 期待される応答:
# {"status":"healthy","service":"ejan-api","version":"1.0.0"}
```

### 2. APIドキュメントの確認
```bash
# ブラウザで以下のURLを開く
# Swagger UI: http://localhost:8000/docs
# ReDoc: http://localhost:8000/redoc
```

### 3. CORS動作確認
```bash
# フロントエンド（localhost:3000）からのリクエストをシミュレート
curl -X OPTIONS http://localhost:8000/health \
  -H "Origin: http://localhost:3000" \
  -H "Access-Control-Request-Method: GET" \
  -v

# レスポンスヘッダーに以下が含まれることを確認:
# Access-Control-Allow-Origin: http://localhost:3000
```

### 4. テストの実行
```bash
# すべてのテストを実行
uv run pytest tests/ -v

# 特定のテストファイルを実行
uv run pytest tests/integration/test_app_setup.py -v
uv run pytest tests/unit/test_config.py -v

# カバレッジレポート付きで実行
uv run pytest tests/ --cov=app --cov-report=term-missing
```

### 5. コード品質チェック
```bash
# Black（フォーマッター）
uv run black app/ --check  # チェックのみ
uv run black app/          # 自動修正

# Ruff（リンター）
uv run ruff check app/

# Mypy（型チェック）
uv run mypy app/ --config-file mypy.ini

# すべてを一度に実行
uv run black app/ && uv run ruff check app/ && uv run mypy app/
```

### 6. エラー処理の動作確認
```bash
# 404エラーの確認
curl http://localhost:8000/nonexistent
# 期待される応答: {"detail":"Not Found","status_code":404,"type":"http_error"}

# 不正なリクエストでバリデーションエラーを確認（エンドポイント実装後）
# curl -X POST http://localhost:8000/api/styles/generate \
#   -H "Content-Type: application/json" \
#   -d '{"invalid":"data"}'
```