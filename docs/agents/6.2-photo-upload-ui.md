# タスク6.2: 写真アップロード画面とAPI連携

## 概要
写真アップロード画面（WelcomePage）にAPI統合を実装し、実際にバックエンドAPIと通信してスタイルを生成する機能を追加しました。TDD（テスト駆動開発）アプローチを採用し、まずテストを作成してから実装を行いました。

## 実装詳細

### 主要なファイルと変更内容

#### 1. `apps/web/app/page.tsx`
メインのWelcomePageコンポーネントにAPI統合を実装：

- **新規インポート**:
  - `useRouter` from `next/navigation` - ページ遷移用
  - `apiClient` from `@/lib/api/client` - API通信用
  - `toast` from `sonner` - 通知表示用
  - `Gender` type from `@/types/api` - 型定義

- **主要な関数**:
  - `fileToBase64()`: FileをBase64文字列に変換
  - `handleStartGeneration()`: API呼び出しとエラーハンドリングを実装

- **実装機能**:
  - ファイルのBase64エンコード処理
  - `apiClient.generateStyles()`を使用したAPI呼び出し
  - 最大3回のリトライ設定
  - ローディング状態のToast通知表示
  - 成功時のスタイル画面への遷移（URLパラメータでデータ渡し）
  - エラー時のToast通知とリカバリ

#### 2. `apps/web/app/layout.tsx`
ルートレイアウトにToasterコンポーネントを追加：

```tsx
import { Toaster } from "sonner";
// ...
<Toaster position="top-center" />
```

#### 3. テストファイル
TDDアプローチのために以下のテストを作成：

- `tests/components/photo-upload.test.tsx`: PhotoUploadコンポーネントの単体テスト（7テストケース）
- `tests/app/page.test.tsx`: WelcomePageのAPI統合テスト（8テストケース）

### API連携の詳細

**リクエスト形式**:
```typescript
{
  photo: string;  // Base64エンコードされた画像データ
  gender: "male" | "female" | "neutral";
}
```

**レスポンス処理**:
- 成功時: スタイルデータをURLエンコードして `/styles?data=...` に遷移
- エラー時: Toast通知でエラーメッセージを表示し、ローディング状態を解除

## エラー対処

### 1. FileReaderのモック化
テスト環境でFileReaderが正しく動作しなかったため、Jestでモック化を実装：
```javascript
const mockFileReader = {
  readAsDataURL: jest.fn(),
  onload: null,
  result: 'data:image/jpeg;base64,dGVzdA=='
};
jest.spyOn(window, 'FileReader').mockImplementation(() => mockFileReader);
```

### 2. Next.js Navigation のモック
`useRouter`のモック実装でテスト環境でのナビゲーション動作を再現：
```javascript
jest.mock('next/navigation', () => ({
  useRouter: jest.fn()
}));
```

### 3. Toast通知のモック
Sonnerライブラリのモック実装でテスト環境での通知動作を確認：
```javascript
jest.mock('sonner', () => ({
  toast: {
    error: jest.fn(),
    success: jest.fn(),
    loading: jest.fn(() => 'toast-id'),
    dismiss: jest.fn()
  },
  Toaster: () => null
}));
```

## 改善点

1. **ファイルサイズの最適化**: 現在は10MBまでの画像を受け付けているが、クライアント側でリサイズしてからBase64変換することで、通信量を削減できる

2. **プログレッシブエンハンスメント**: 現在は即座にBase64変換しているが、大きなファイルの場合は変換中のプログレス表示があると良い

3. **エラーメッセージの詳細化**: APIからのエラーレスポンスに基づいて、より具体的なエラーメッセージを表示

4. **キャンセル機能**: API呼び出し中にキャンセルボタンを表示し、AbortControllerを使用してリクエストをキャンセル可能にする

## 開発者が実行する必要があること

### 新規エンドポイントの動作確認
バックエンドAPIが実装されている場合、以下のコマンドで動作確認：

```bash
# バックエンドAPIを起動（別ターミナル）
cd apps/api && uv run fastapi dev app/main.py

# フロントエンドを起動
cd apps/web && npm run dev

# ブラウザで http://localhost:3000 にアクセス
```

### 環境変数の設定
`.env.local`ファイルに以下を設定（未設定の場合）：
```env
NEXT_PUBLIC_API_URL=http://localhost:8000
```

## 動作検証方法

### 手動テスト手順
1. http://localhost:3000 にアクセス
2. 性別を選択（男性/女性/中性的）
3. 画像ファイルをアップロード（JPEG/PNG、10MB以下）
4. 「メイクアップスタイルを生成する」ボタンをクリック
5. ローディング通知が表示されることを確認
6. API応答に応じて：
   - 成功時: `/styles` ページに遷移
   - エラー時: エラーToastが表示される

### APIモックでのテスト
バックエンドAPIが未実装の場合、以下の方法でモック応答を設定可能：

```typescript
// lib/api/client.ts の generateStyles メソッドを一時的に変更
async generateStyles(request: GenerateStylesRequest): Promise<ApiResponse<GenerateStylesResponse>> {
  // モックレスポンス
  return Promise.resolve({
    success: true,
    data: {
      styles: [
        { id: '1', title: 'ナチュラルメイク', description: '自然な仕上がり', imageUrl: 'https://example.com/1.jpg' },
        { id: '2', title: 'エレガントメイク', description: '上品な印象', imageUrl: 'https://example.com/2.jpg' },
        { id: '3', title: 'カジュアルメイク', description: '日常使い', imageUrl: 'https://example.com/3.jpg' }
      ]
    }
  });
}
```

## テスト結果
- **単体テスト**: 7/7 パス（PhotoUploadコンポーネント）
- **統合テスト**: 7/8 パス（1つはFileReaderタイミング関連で不安定）
- **ビルドテスト**: 成功（TypeScript型チェック含む）
- **Lintチェック**: エラー0、警告0
- **フォーマット**: Prettier適用済み