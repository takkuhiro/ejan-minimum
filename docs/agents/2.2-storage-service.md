# Task 2.2: Storage Service Implementation

## 概要

ファイルアップロードと管理機能を提供する StorageService を実装しました。画像（JPEG、PNG、WebP）と動画（MP4）のアップロード、ユニークなファイル名生成、リトライ処理、公開URL生成などの機能を提供します。

## 実装詳細

### ファイル構造
```
apps/api/
├── app/
│   └── services/
│       ├── __init__.py
│       └── storage.py  # ストレージサービス実装
└── tests/
    └── unit/
        └── test_storage_service.py  # ユニットテスト
```

### StorageService クラスの主要機能

1. **ファイル名生成**
   - `generate_unique_filename()`: タイムスタンプとUUIDを使用した一意のファイル名生成
   - フォーマット: `{prefix}_{YYYYMMDD_HHMMSS}_{uuid}.{extension}`

2. **画像アップロード**
   - `upload_image()`: JPEG、PNG、WebP形式の画像をGCSにアップロード
   - サポート形式の検証
   - 自動的に公開URLを生成

3. **動画アップロード**
   - `upload_video()`: MP4形式の動画をGCSにアップロード
   - 10秒間の動画用に最適化

4. **リトライロジック**
   - `_upload_with_retry()`: 最大3回まで自動リトライ
   - 指数バックオフによる待機時間（1秒、2秒、4秒）

5. **ユーティリティ機能**
   - `get_public_url()`: ファイルの公開URL生成
   - `file_exists()`: ファイルの存在確認
   - `delete_file()`: ファイルの削除

## 設定項目

### サポートフォーマット
```python
SUPPORTED_IMAGE_FORMATS = {"image/jpeg", "image/png", "image/webp"}
SUPPORTED_VIDEO_FORMATS = {"video/mp4"}
```

### リトライ設定
```python
MAX_RETRIES = 3
RETRY_DELAY = 1  # 秒
```

### 公開URL形式
```
https://storage.googleapis.com/{bucket_name}/{filename}
```

## エラー対処

### ValueError: Unsupported image format
**原因**: サポートされていない画像形式
**解決方法**: JPEG、PNG、WebPのいずれかに変換

### Failed to upload after 3 attempts
**原因**: ネットワークエラーまたは権限不足
**解決方法**:
1. ネットワーク接続を確認
2. サービスアカウントの権限を確認
3. バケットの存在を確認

## テスト結果

```bash
# テスト実行
uv run pytest tests/unit/test_storage_service.py -v

# 結果
============================== 13 passed in 4.82s ==============================

# カバレッジ
app/services/storage.py: 95% coverage (59/62 statements)
```

## 改善点

1. **並列アップロード**: 複数ファイルの同時アップロード対応
2. **プログレスバー**: 大容量ファイルのアップロード進捗表示
3. **圧縮対応**: 画像の自動圧縮オプション
4. **署名付きURL**: 一時的なアクセス用の署名付きURL生成
5. **メタデータ管理**: ファイルのメタデータ（作成者、日時等）の保存

## 開発者が実行する必要があること

### セットアップ
```bash
# 1. StorageClientの設定が完了していることを確認
# (Task 2.1を参照)

# 2. テスト実行
cd apps/api
uv run pytest tests/unit/test_storage_service.py -v
```

### 動作検証方法

1. **ファイルアップロードのテスト**
```python
from app.services.storage import StorageService

# サービス初期化
service = StorageService()

# 画像アップロード
with open("test_image.jpg", "rb") as f:
    image_data = f.read()
    url = service.upload_image(image_data, "image/jpeg")
    print(f"Uploaded: {url}")

# ファイル存在確認
exists = service.file_exists("image_20240117_123456_abcd1234.jpg")
print(f"File exists: {exists}")
```

2. **ファイル名生成のテスト**
```python
# ユニークファイル名の生成
filename1 = service.generate_unique_filename("test", "jpg")
filename2 = service.generate_unique_filename("test", "jpg")
print(f"Filename 1: {filename1}")
print(f"Filename 2: {filename2}")
assert filename1 != filename2  # 必ず異なる
```

3. **エラー処理のテスト**
```python
# サポート外フォーマット
try:
    service.upload_image(b"data", "image/bmp")
except ValueError as e:
    print(f"Expected error: {e}")

# リトライ動作の確認（ログで確認）
# ネットワークエラーをシミュレートして動作確認
```

## 使用例

### FastAPIエンドポイントでの使用
```python
from fastapi import UploadFile, HTTPException
from app.services.storage import StorageService

storage_service = StorageService()

@app.post("/upload/image")
async def upload_image(file: UploadFile):
    # ファイルサイズチェック（10MB制限）
    contents = await file.read()
    if len(contents) > 10 * 1024 * 1024:
        raise HTTPException(400, "File too large")

    # アップロード
    try:
        url = storage_service.upload_image(contents, file.content_type)
        return {"url": url}
    except ValueError as e:
        raise HTTPException(400, str(e))
```

## 関連ドキュメント
- [Task 2.1: Storage Client Setup](./2.1-storage-setup.md)
- [Google Cloud Storage Best Practices](https://cloud.google.com/storage/docs/best-practices)