# タスク3.2: Nano Banana画像生成サービス

## 概要

Nano Banana (Gemini 2.5 Flash Image Preview)を使用して、ユーザーの顔写真に基づいたメイクアップスタイルを生成するサービスを実装しました。性別とスタイルバリエーションに対応し、3パターンのスタイルを生成します。

## 実装詳細

### ファイル構成

- `app/services/image_generation.py` - 画像生成サービス
- `tests/unit/test_image_generation.py` - ユニットテスト

### クラス構造

#### ImageGenerationService

スタイル付き画像を生成するメインサービスクラス。

**主要メソッド:**

- `generate_single_style()` - 1つのスタイル生成
- `generate_three_styles()` - 3パターンのスタイル生成
- `process_upload_and_generate()` - Base64画像処理とスタイル生成
- `validate_image_size()` - 画像サイズ検証（10MB制限）
- `extract_title_from_description()` - 説明からタイトル抽出

### スタイルバリエーション

3つのスタイルパターン：

1. **Natural Daytime Look** - ナチュラルな普段使いのメイク
2. **Elegant Evening Style** - エレガントな夜のメイク
3. **Bold Party Look** - 大胆でトレンディなパーティーメイク

### 性別対応

```python
class Gender(str, Enum):
    MALE = "male"      # 男性向けスタイル
    FEMALE = "female"  # 女性向けスタイル
    NEUTRAL = "neutral" # 中性的/ユニセックス
```

### コスト

- 1枚の画像生成: $0.039
- 3パターン生成: $0.117 (3 × $0.039)

## 設定項目

### 依存サービス

- `AIClient` - Gemini APIクライアント
- `StorageService` - Cloud Storageサービス

### モデル設定

```python
self.model_name = "gemini-2.5-flash-image-preview"
```

## エラー対処

### 一般的な問題と解決方法

1. **画像サイズ制限**
   - 問題: `ImageGenerationError: Image size exceeds 10MB limit`
   - 解決: クライアント側で画像をリサイズ

2. **Base64デコードエラー**
   - 問題: `ImageGenerationError: Invalid base64 image`
   - 解決: 正しいBase64エンコーディングを確認

3. **AIが画像を生成しない**
   - 問題: `ImageGenerationError: No image generated by AI`
   - 解決: プロンプトを調整、APIキーを確認

## テスト結果

```bash
# テスト実行コマンド
cd apps/api
uv run pytest tests/unit/test_image_generation.py -v

# 結果: 15個のテストすべて合格
✓ スタイルプロンプト生成テスト
✓ 単一スタイル生成テスト
✓ 3スタイル生成テスト
✓ Base64アップロード処理テスト
✓ エラーハンドリングテスト
```

## 改善点

1. **並列処理**: 3つのスタイルを同時に生成して高速化
2. **プログレッシブアップロード**: 大きな画像のストリーム処理
3. **スタイルカスタマイズ**: より多くのスタイルオプション
4. **サムネイル生成**: プレビュー用の小さな画像生成

## 開発者が実行する必要があること

### 初期セットアップ

1. AIクライアントが動作していることを確認（タスク3.1参照）

2. Cloud Storageサービスが動作していることを確認（タスク2.2参照）

3. 依存関係インストール:
   ```bash
   cd apps/api
   uv add google-genai pillow
   ```

## 動作検証方法

### 単体テスト

```bash
cd apps/api

# 画像生成テストのみ実行
uv run pytest tests/unit/test_image_generation.py -v

# 特定のテストのみ
uv run pytest tests/unit/test_image_generation.py::TestImageGenerationService::test_generate_three_styles -v
```

### 手動テスト

```python
# Python REPLで確認
cd apps/api
uv run python

>>> import asyncio
>>> from app.services.ai_client import AIClient
>>> from app.services.storage import StorageService
>>> from app.services.image_generation import ImageGenerationService, Gender
>>> from google.genai import types

>>> # サービス初期化
>>> ai_client = AIClient()
>>> storage_service = StorageService()
>>> service = ImageGenerationService(ai_client, storage_service)

>>> # Base64テスト画像を作成（実際はユーザーから受け取る）
>>> import base64
>>> with open("test_image.jpg", "rb") as f:
...     base64_photo = base64.b64encode(f.read()).decode("utf-8")

>>> # スタイル生成
>>> async def test():
...     styles = await service.process_upload_and_generate(
...         base64_photo=base64_photo,
...         gender=Gender.FEMALE
...     )
...     for style in styles:
...         print(f"{style.title}: {style.image_url}")

>>> asyncio.run(test())
```

### APIレスポンス例

```json
{
  "styles": [
    {
      "id": "uuid-1",
      "title": "Natural Daytime Look",
      "description": "A fresh and clean appearance with subtle makeup...",
      "image_url": "https://storage.googleapis.com/bucket/styles/uuid-1.png"
    },
    {
      "id": "uuid-2",
      "title": "Elegant Evening Style",
      "description": "Sophisticated makeup with bold lips and defined eyes...",
      "image_url": "https://storage.googleapis.com/bucket/styles/uuid-2.png"
    },
    {
      "id": "uuid-3",
      "title": "Bold Party Look",
      "description": "Dramatic and trendy makeup with vibrant colors...",
      "image_url": "https://storage.googleapis.com/bucket/styles/uuid-3.png"
    }
  ]
}
```

## 関連ファイル

- タスク3.1: [AIクライアント](./3.1-ai-integration.md)
- タスク2.2: [Storageサービス](./2.2-storage-service.md)
- サンプル: `apps/api/samples/image_generation_with_nano_banana.py`
