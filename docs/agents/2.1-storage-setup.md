# Task 2.1: Cloud Storage Client Setup

## 概要

Google Cloud Storage (GCS) クライアントのセットアップと接続管理機能を実装しました。このクライアントは、Ejanアプリケーションで生成される画像と動画ファイルをGCSバケットに保存するための基盤となります。

## 実装詳細

### ファイル構造
```
apps/api/
├── app/
│   └── core/
│       └── storage.py  # GCSクライアント実装
└── tests/
    └── unit/
        └── test_storage_client.py  # ユニットテスト
```

### StorageClient クラス

`app/core/storage.py` に実装された主要な機能:

1. **環境変数からのバケット名取得**
   - `STORAGE_BUCKET` 環境変数から設定を読み込み
   - 環境変数が設定されていない場合はエラーを発生

2. **GCSクライアントの初期化**
   - `google-cloud-storage` ライブラリを使用
   - サービスアカウント認証（ejan-dev-sa）対応

3. **バケット管理機能**
   - `get_bucket()`: バケットインスタンスの取得
   - `bucket_exists()`: バケットの存在確認

## 設定項目

### 環境変数
```bash
# apps/api/.env
STORAGE_BUCKET=ejan-demo-storage  # GCSバケット名
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json  # サービスアカウントキー（オプション）
```

### サービスアカウント権限
以下の権限が必要です:
- `storage.buckets.get`
- `storage.objects.create`
- `storage.objects.delete`
- `storage.objects.get`
- `storage.objects.list`

推奨ロール: `Storage Object Admin`

## エラー対処

### ValueError: STORAGE_BUCKET environment variable is required
**原因**: 環境変数 `STORAGE_BUCKET` が設定されていない
**解決方法**: `.env` ファイルに `STORAGE_BUCKET=<バケット名>` を追加

### 認証エラー
**原因**: サービスアカウントの認証情報が不適切
**解決方法**:
1. `GOOGLE_APPLICATION_CREDENTIALS` を正しいパスに設定
2. または、デフォルト認証を使用（`gcloud auth application-default login`）

## テスト結果

```bash
# テスト実行
uv run pytest tests/unit/test_storage_client.py -v

# 結果
============================== 7 passed in 1.85s ==============================

# カバレッジ
app/core/storage.py: 100% coverage
```

## 改善点

1. **バケット作成機能**: 存在しないバケットの自動作成（開発環境用）
2. **リージョン設定**: 複数リージョン対応のための設定追加
3. **接続プーリング**: パフォーマンス改善のための接続管理
4. **メトリクス**: GCS操作のモニタリング機能

## 開発者が実行する必要があること

### 初回セットアップ
```bash
# 1. 依存関係のインストール
cd apps/api
uv add google-cloud-storage

# 2. 環境変数の設定
echo "STORAGE_BUCKET=your-bucket-name" >> .env

# 3. サービスアカウントの設定（必要に応じて）
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/service-account.json"

# 4. バケットの作成（必要に応じて）
gsutil mb gs://your-bucket-name
```

### 動作検証方法

1. **ユニットテストの実行**
```bash
cd apps/api
uv run pytest tests/unit/test_storage_client.py -v
```

2. **接続テスト**
```python
# Python REPL で確認
from app.core.storage import StorageClient

client = StorageClient()
print(f"Bucket: {client.bucket_name}")
print(f"Exists: {client.bucket_exists()}")
```

3. **バケット権限の確認**
```bash
# CLIで権限確認
gsutil ls gs://${STORAGE_BUCKET}/
```

## 関連ドキュメント
- [Task 2.2: Storage Service](./2.2-storage-service.md)
- [Google Cloud Storage Python Client](https://cloud.google.com/storage/docs/reference/libraries#client-libraries-install-python)