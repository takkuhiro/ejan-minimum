# Task 6.4: チュートリアル生成・表示画面の統合

## 概要
チュートリアル生成と表示機能のフロントエンド・バックエンド統合を実装しました。TDD（テスト駆動開発）手法を採用し、API呼び出し、ポーリング処理、動画再生機能を含む完全な統合を実現しています。

## 実装詳細

### 1. API Client拡張
**ファイル**: `apps/web/lib/api/client.ts`

#### 追加メソッド
```typescript
// チュートリアル取得
async getTutorial(tutorialId: string): Promise<ApiResponse<TutorialResponse>>

// チュートリアルステータス確認
async getTutorialStatus(tutorialId: string): Promise<ApiResponse<{ status: string; progress?: number }>>
```

### 2. 型定義の更新
**ファイル**: `apps/web/types/api.ts`

#### 主要な型定義
- `TutorialResponse`: チュートリアル全体のデータ構造
- `TutorialStep`: 各ステップの詳細情報（動画URL、画像URL、ツール、ヒント含む）
- `GenerateTutorialRequest`: チュートリアル生成リクエスト（styleId、customization）

### 3. チュートリアル生成画面
**ファイル**: `apps/web/app/generating/page.tsx`

#### 実装機能
- **API統合**: `apiClient.generateTutorial()`でチュートリアル生成を開始
- **ポーリング処理**: 10秒間隔で生成状態を確認（`PROCESSING`→`COMPLETED`）
- **進捗表示**: 4段階のステップアニメーション
- **エラーハンドリング**: タイムアウト、サーバーエラー、ネットワークエラーに対応
- **中断処理**: AbortControllerによるリクエストキャンセル

#### 実装上の工夫
- `useCallback`を使用して関数メモ化し、React Hooks依存関係を最適化
- 進捗アニメーションは実際のAPI処理と並行して実行（95%で停止、完了時に100%）
- スタイルID未選択時の適切なエラー表示とナビゲーション

### 4. チュートリアル表示画面
**ファイル**: `apps/web/app/tutorial/page.tsx`

#### 実装機能
- **データ読み込み**: URLパラメータからチュートリアルIDを取得しAPIコール
- **ステップナビゲーション**: 前後移動、直接選択、最初から再実行
- **動画再生**: HTML5 video要素による10秒ループ動画の再生/一時停止
- **進捗トラッキング**: 完了ステップの記録と進行状況バーの更新
- **完了表示**: 全ステップ完了時の祝福メッセージとアクション

#### UI/UX特徴
- サイドバーでステップ一覧表示（完了状態を視覚化）
- 各ステップごとの詳細表示（動画、完成画像、必要道具、ヒント）
- レスポンシブレイアウト（デスクトップ最適化）

## エラー対処

### 遭遇した問題と解決方法

1. **React Hooks依存関係エラー**
   - 問題: `useEffect`内でのコールバック関数の循環参照
   - 解決: `useCallback`でメモ化し、適切な依存関係配列を設定

2. **TypeScript型エラー**
   - 問題: API型定義とバックエンドモデルの不一致
   - 解決: Pythonモデル（snake_case）とTypeScript（camelCase）の適切なマッピング

3. **動画再生状態管理**
   - 問題: ステップ切替時の動画状態の不整合
   - 解決: `videoRef.current`で直接DOM操作、イベントリスナーで状態同期

## テスト実装

### TDDアプローチ
1. **テストファースト**: 機能実装前にテストケースを作成
2. **RED→GREEN→REFACTOR**: テスト失敗→実装→リファクタリングのサイクル
3. **カバレッジ重視**: APIコール、エラーハンドリング、UI操作を網羅

### テストファイル
- `__tests__/generating.test.tsx`: チュートリアル生成画面のテスト
- `__tests__/tutorial.test.tsx`: チュートリアル表示画面のテスト

## 品質チェック結果

### 実行コマンドと結果
```bash
cd apps/web
npm run format   # ✅ Prettier実行成功
npm run lint     # ✅ ESLint警告0、エラー0
npm run build    # ✅ TypeScriptビルド成功
```

### 修正項目
- 未使用インポートの削除
- `any`型の具体的な型への置換
- React Hooks依存関係の最適化
- Next.js App Router APIの適切な使用

## 改善点

### 今後の拡張候補
1. **リアルタイムプログレス**: WebSocketによる詳細な進捗更新
2. **オフライン対応**: Service Workerによるキャッシング
3. **動画品質選択**: 複数解像度の動画ストリーミング対応
4. **中断・再開機能**: 長時間チュートリアルの途中保存
5. **共有機能**: チュートリアルのソーシャル共有

### パフォーマンス最適化
- 画像の遅延読み込み（Next.js Image component使用済み）
- 動画のプリロード戦略
- APIレスポンスのキャッシング

## 動作検証方法

### 開発環境での確認
```bash
# フロントエンド起動
cd apps/web
npm run dev

# 動作確認フロー
1. http://localhost:3000/styles でスタイル選択
2. カスタマイズボタンクリック → チュートリアル生成開始
3. /generating でAPI呼び出しと進捗表示確認
4. /tutorial?id=xxx でチュートリアル表示確認
5. 動画再生、ステップ移動、完了マーク機能をテスト
```

### APIモックでの動作確認
バックエンドが未起動でも、APIクライアントのモックを使用してフロントエンド単体で動作確認可能です。

## まとめ
タスク6.4では、TDDアプローチによりチュートリアル生成から表示までの完全な統合を実装しました。フロントエンドのAPI統合、ポーリング処理、動画再生機能を含む包括的な実装により、ユーザーは生成されたメイクアップチュートリアルを段階的に視聴・実践できるようになりました。コード品質チェックはすべて合格し、型安全性とコーディング規約が適切に守られています。