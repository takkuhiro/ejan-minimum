# タスク1.2: リクエスト/レスポンスのデータモデル定義

## 概要
EJAN APIのリクエストとレスポンスのバリデーションおよびシリアライゼーションのためのPydanticデータモデルを実装しました。Kent BeckのTDD手法に従い、テスト駆動開発で実装を進めました。

## 実装詳細

### ファイル構造
```
apps/api/
├── app/models/
│   ├── __init__.py        # モジュール初期化
│   ├── request.py         # リクエストモデル定義
│   └── response.py        # レスポンスモデル定義
└── tests/unit/
    └── test_models.py     # ユニットテスト（22テスト）
```

### 実装したモデル

#### リクエストモデル (request.py)

1. **Gender (Enum)**
   - 性別選択のための列挙型
   - 値: `male`, `female`, `neutral`

2. **PhotoUploadRequest**
   - 写真アップロード用リクエスト
   - フィールド:
     - `photo`: Base64エンコード画像データ
     - `gender`: 性別選択
   - バリデーション:
     - Base64形式検証
     - ファイルサイズ制限 (10MB)
     - 画像フォーマット検証 (PNG, JPEG, WebP)

3. **TutorialGenerationRequest**
   - チュートリアル生成用リクエスト
   - フィールド:
     - `style_id`: 選択されたスタイルのID
     - `customization_text`: カスタマイズテキスト（オプション、最大1000文字）

#### レスポンスモデル (response.py)

1. **GeneratedStyle**
   - 生成されたスタイル情報
   - フィールド:
     - `id`: スタイルID
     - `title`: タイトル
     - `description`: 説明
     - `image_url`: 画像URL（URL形式検証付き）

2. **StylesGenerationResponse**
   - スタイル生成エンドポイントのレスポンス
   - フィールド:
     - `styles`: GeneratedStyleのリスト（最小1つ）

3. **TutorialStep**
   - チュートリアルの各ステップ
   - フィールド:
     - `step_number`: ステップ番号（正の整数）
     - `title`: ステップタイトル
     - `description`: 詳細説明
     - `image_url`: 完成イメージURL
     - `video_url`: 動画URL
     - `tools`: 必要な道具リスト（空リスト可）

4. **TutorialResponse**
   - チュートリアル生成エンドポイントのレスポンス
   - フィールド:
     - `id`: チュートリアルID
     - `title`: タイトル
     - `description`: 説明
     - `total_steps`: 総ステップ数
     - `steps`: TutorialStepのリスト
   - バリデーション: total_stepsとstepsリスト長の一致確認

5. **ErrorResponse**
   - エラーレスポンス
   - フィールド:
     - `error`: エラータイプ
     - `message`: エラーメッセージ
     - `details`: 追加詳細（オプション）

### ユーティリティ関数

1. **validate_image_format(data: bytes) -> str**
   - バイナリデータから画像フォーマットを検証
   - サポート: PNG, JPEG, WebP
   - ファイルシグネチャによる判定

2. **validate_file_size(data: bytes, max_size_mb: int) -> bool**
   - ファイルサイズ検証
   - デフォルト最大サイズ: 10MB

## 設定項目
環境変数の設定は不要です（データモデルのみの実装のため）。

## エラー対処
実装中に遭遇した問題と解決方法：

1. **テスト失敗の修正**
   - 問題: Base64テストデータが有効なPNG画像でなかった
   - 解決: 有効なPNGシグネチャを含むテストデータに変更

2. **mypy型チェックエラー**
   - 問題: `base64.binascii.Error`の参照エラー
   - 解決: `binascii`を直接インポートして使用

## テスト結果
- テスト数: 22個
- 成功: 22個
- 失敗: 0個
- カバレッジ: モデル定義の全機能をカバー

### テストカテゴリ
1. Enumのバリデーション
2. リクエストモデルのバリデーション
3. レスポンスモデルのバリデーション
4. URL形式検証
5. ファイルサイズ制限
6. Base64エンコーディング検証
7. 画像フォーマット検証
8. エラーレスポンスのシリアライゼーション

## 改善点
1. **画像フォーマット検証の強化**
   - より厳密なバイナリ検証の実装検討
   - 追加フォーマット（GIF等）のサポート検討

2. **パフォーマンス最適化**
   - 大きなBase64データの処理最適化
   - バリデーションロジックのキャッシング

3. **エラーメッセージの国際化**
   - 日本語エラーメッセージのサポート
   - メッセージのカスタマイズ機能

## 開発者が実行する必要があること

### 依存関係のインストール
```bash
cd apps/api
uv add pydantic
uv add --dev pytest pytest-asyncio pytest-mock
```

### 動作検証方法
```bash
# テストの実行
cd apps/api
uv run pytest tests/unit/test_models.py -v

# コード品質チェック
uv run black app/models/
uv run ruff check app/models/
uv run mypy app/models/ --strict
```

### 使用例
```python
from app.models.request import PhotoUploadRequest, Gender
from app.models.response import GeneratedStyle, ErrorResponse
import base64

# リクエストの作成
with open("image.png", "rb") as f:
    image_data = base64.b64encode(f.read()).decode("utf-8")

request = PhotoUploadRequest(
    photo=image_data,
    gender=Gender.FEMALE
)

# レスポンスの作成
style = GeneratedStyle(
    id="style-001",
    title="Natural Look",
    description="日常使いに最適なナチュラルメイク",
    image_url="https://storage.googleapis.com/bucket/style-001.jpg"
)

# エラーレスポンス
error = ErrorResponse(
    error="ValidationError",
    message="画像サイズが10MBを超えています",
    details={"max_size": "10MB", "actual_size": "15MB"}
)
```

## 次のステップ
このデータモデルは以下のタスクで使用されます：
- タスク 5.1: スタイル生成エンドポイントの実装
- タスク 5.2: チュートリアル生成エンドポイントの実装
- タスク 5.3: スタイル詳細取得エンドポイントの実装