# タスク3.3: Gemini Structured Outputによる手順構造化

## 概要

GeminiのStructured Output機能を使用して、メイクアップチュートリアルを構造化されたJSON形式で生成するサービスを実装しました。ステップごとの詳細な手順、所要時間、必要な道具を含む完全なチュートリアル構造を生成します。

## 実装詳細

### ファイル構成

- `app/services/tutorial_structure.py` - チュートリアル構造化サービス
- `tests/unit/test_tutorial_structure.py` - ユニットテスト

### データモデル (Pydantic)

#### Tool
```python
class Tool(BaseModel):
    name: str               # 道具名
    description: str        # 説明
```

#### MakeupStep
```python
class MakeupStep(BaseModel):
    step_number: int        # ステップ番号 (1から始まる)
    title: str              # ステップタイトル
    description: str        # 詳細説明
    duration_seconds: int   # 所要時間（秒）
    tools_needed: List[str] # 必要な道具リスト
```

#### MakeupProcedure
```python
class MakeupProcedure(BaseModel):
    title: str                     # メイクアップ名
    description: str               # 全体説明
    total_duration_minutes: int    # 合計時間（分）
    difficulty_level: str          # 難易度 (beginner/intermediate/advanced)
    steps: List[MakeupStep]        # ステップリスト
    required_tools: List[Tool]     # 必要道具リスト
```

### クラス構造

#### TutorialStructureService

**主要メソッド:**

- `generate_tutorial_structure()` - チュートリアル構造生成
- `get_response_schema()` - JSONスキーマ取得
- `validate_procedure()` - 生成された手順の検証
- `calculate_total_duration()` - 合計時間計算
- `format_for_response()` - APIレスポンス形式へ変換

### バリデーション

- 難易度は`beginner`、`intermediate`、`advanced`のみ
- ステップ番号は連番、1から開始
- 合計時間は最大120分（2時間）
- 最低1ステップが必要

## 設定項目

### モデル設定

```python
self.model_name = "gemini-2.5-flash"
```

### JSONスキーマ

Structured Outputのresponse_schemaで、返却されるJSONの構造を厳密に定義しています。

## エラー対処

### 一般的な問題と解決方法

1. **構造化出力のバリデーションエラー**
   - 問題: `TutorialStructureError: Invalid tutorial structure`
   - 解決: JSONスキーマを確認、Pydanticモデルを調整

2. **ステップ番号の不整合**
   - 問題: ステップ番号が連続していない
   - 解決: `validate_procedure()`で自動検証

3. **難易度の不正な値**
   - 問題: `ValidationError: Difficulty must be one of ['beginner', 'intermediate', 'advanced']`
   - 解決: 正しい難易度値を指定

## テスト結果

```bash
# テスト実行コマンド
cd apps/api
uv run pytest tests/unit/test_tutorial_structure.py -v

# 結果: 19個のテストすべて合格
✓ データモデルテスト
✓ プロンプト生成テスト
✓ 構造化出力生成テスト
✓ バリデーションテスト
✓ 時間計算テスト
```

## 改善点

1. **ステップごとの画像生成**: 各ステップにビジュアルを追加
2. **多言語対応**: 英語以外の言語サポート
3. **カスタム難易度**: ユーザー定義の難易度レベル
4. **動的ステップ調整**: ユーザースキルに応じた調整

## 開発者が実行する必要があること

### 初期セットアップ

1. AIクライアントが動作していることを確認（タスク3.1参照）

2. 依存関係インストール:
   ```bash
   cd apps/api
   uv add pydantic pydantic-settings
   ```

## 動作検証方法

### 単体テスト

```bash
cd apps/api

# 構造化出力テストのみ実行
uv run pytest tests/unit/test_tutorial_structure.py -v

# 特定のテストのみ
uv run pytest tests/unit/test_tutorial_structure.py::TestTutorialStructureService -v
```

### 手動テスト

```python
# Python REPLで確認
cd apps/api
uv run python

>>> import asyncio
>>> from app.services.ai_client import AIClient
>>> from app.services.tutorial_structure import TutorialStructureService

>>> # サービス初期化
>>> ai_client = AIClient()
>>> service = TutorialStructureService(ai_client)

>>> # チュートリアル生成
>>> async def test():
...     procedure = await service.generate_tutorial_structure(
...         style_description="Natural daytime makeup with subtle enhancements",
...         gender="female"
...     )
...     print(f"Title: {procedure.title}")
...     print(f"Difficulty: {procedure.difficulty_level}")
...     print(f"Total Time: {procedure.total_duration_minutes} minutes")
...     print(f"Steps: {len(procedure.steps)}")
...     for step in procedure.steps:
...         print(f"  {step.step_number}. {step.title} ({step.duration_seconds}s)")

>>> asyncio.run(test())
```

### 出力例

```json
{
  "title": "Natural Daytime Makeup Look",
  "description": "A fresh and clean makeup style perfect for everyday wear",
  "total_duration_minutes": 15,
  "difficulty_level": "beginner",
  "steps": [
    {
      "step_number": 1,
      "title": "Prep Your Skin",
      "description": "Cleanse and moisturize your face for a smooth base",
      "duration_seconds": 60,
      "tools_needed": ["Cleanser", "Moisturizer", "Primer"]
    },
    {
      "step_number": 2,
      "title": "Apply Foundation",
      "description": "Use a light coverage foundation for natural look",
      "duration_seconds": 90,
      "tools_needed": ["Foundation", "Foundation Brush", "Beauty Sponge"]
    },
    {
      "step_number": 3,
      "title": "Conceal Imperfections",
      "description": "Cover dark circles and blemishes with concealer",
      "duration_seconds": 60,
      "tools_needed": ["Concealer", "Concealer Brush"]
    }
  ],
  "required_tools": [
    {
      "name": "Foundation",
      "description": "Light to medium coverage liquid foundation"
    },
    {
      "name": "Concealer",
      "description": "Creamy concealer one shade lighter than foundation"
    },
    {
      "name": "Foundation Brush",
      "description": "Flat synthetic brush for smooth application"
    }
  ]
}
```

## 関連ファイル

- タスク3.1: [AIクライアント](./3.1-ai-integration.md)
- タスク2.3: [チュートリアル生成エンドポイント](./5.2-tutorial-endpoint.md)
- Gemini Structured Output: [Google AIドキュメント](https://ai.google.dev/docs/gemini_api_overview#json-mode)
