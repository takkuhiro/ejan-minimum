# タスク3.1: Gemini API統合基盤

## 概要

Google Generative AI (Gemini) APIと統合するための基盤クライアントを実装しました。このクライアントは画像生成、構造化出力、動画生成など、すべてのAI機能の基盤となります。

## 実装詳細

### ファイル構成

- `app/services/ai_client.py` - AIクライアント実装
- `tests/unit/test_ai_client.py` - ユニットテスト

### クラス構造

#### AIClient

Gemini APIとの通信を管理するメインクラス。

**主要メソッド:**

- `__init__(api_key)` - APIキーで初期化
- `generate_content()` - コンテンツ生成（テキスト/画像）
- `generate_content_with_retry()` - リトライ機能付きコンテンツ生成
- `generate_structured_output()` - JSON構造化出力生成
- `extract_text_from_response()` - レスポンスからテキスト抽出
- `extract_image_from_response()` - レスポンスから画像抽出
- `validate_model_name()` - モデル名の検証

### エラーハンドリング

**カスタム例外クラス:**

- `AIClientError` - 基底例外クラス
- `AIClientInitError` - 初期化エラー
- `AIClientAPIError` - API呼び出しエラー
- `AIClientTimeoutError` - タイムアウトエラー

### リトライ機能

- 最大3回までのリトライ
- 指数バックオフによる待機時間（1秒、2秒、4秒）
- API障害時の自動回復

## 設定項目

### 環境変数

```bash
# .env ファイル
GOOGLE_API_KEY=<Google AI Studio APIキー>
```

### サポートモデル

- `gemini-2.5-flash` - テキスト生成・構造化出力
- `gemini-2.5-flash-image-preview` - 画像生成（Nano Banana）
- `veo-3.0-generate-001` - 動画生成

## エラー対処

### 一般的な問題と解決方法

1. **APIキーエラー**
   - 問題: `AIClientInitError: GOOGLE_API_KEY is not set`
   - 解決: `.env`ファイルにAPIキーを設定

2. **レート制限**
   - 問題: API呼び出しが頻繁すぎる
   - 解決: リトライ機能が自動的に処理

3. **型エラー (mypy)**
   - 問題: Google APIの型定義が不完全
   - 解決: `# type: ignore`コメントで一部無視

## テスト結果

```bash
# テスト実行コマンド
cd apps/api
uv run pytest tests/unit/test_ai_client.py -v

# 結果: 15個のテストすべて合格
✓ APIキー初期化テスト
✓ コンテンツ生成テスト
✓ 画像付きコンテンツ生成テスト
✓ リトライ機能テスト
✓ 構造化出力テスト
✓ テキスト・画像抽出テスト
```

## 改善点

1. **型定義の改善**: Google API SDKの型定義が改善されれば、`type: ignore`を削除可能
2. **キャッシング**: 同じリクエストの結果をキャッシュして効率化
3. **メトリクス収集**: API使用量とコストの追跡
4. **エラーリトライ戦略**: より洗練されたリトライロジック

## 開発者が実行する必要があること

### 初期セットアップ

1. Google AI Studioでアクセス:
   ```
   https://aistudio.google.com/app/apikey
   ```

2. APIキーを生成

3. `.env`ファイルに設定:
   ```bash
   echo "GOOGLE_API_KEY=your-api-key-here" >> apps/api/.env
   ```

4. 依存関係インストール:
   ```bash
   cd apps/api
   uv sync
   ```

## 動作検証方法

### 単体テスト

```bash
cd apps/api

# AIクライアントテストのみ実行
uv run pytest tests/unit/test_ai_client.py -v

# カバレッジレポート付き
uv run pytest tests/unit/test_ai_client.py --cov=app.services.ai_client --cov-report=term-missing
```

### 手動テスト

```python
# Python REPLで確認
cd apps/api
uv run python

>>> from app.services.ai_client import AIClient
>>> client = AIClient()
>>> response = client.generate_content(
...     model="gemini-2.5-flash",
...     prompt="Hello, Gemini!"
... )
>>> print(client.extract_text_from_response(response))
```

## 関連ファイル

- タスク3.2: [画像生成サービス](./3.2-image-generation.md)
- タスク3.3: [構造化出力](./3.3-tutorial-structure.md)
- サンプルコード: `apps/api/samples/`
