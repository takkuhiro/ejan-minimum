# タスク5.2: チュートリアル生成エンドポイントの構築

## 概要

チュートリアル生成エンドポイント `POST /api/tutorials/generate` を実装しました。このエンドポイントは選択されたスタイルに基づいて、ステップバイステップのメイクアップチュートリアルを生成します。

## 実装詳細

### 新規作成ファイル

1. **`apps/api/app/api/routes/tutorials.py`**
   - エンドポイントのルーティング定義
   - リクエスト/レスポンスハンドリング
   - エラーハンドリング（タイムアウト、生成失敗）

2. **`apps/api/app/services/tutorial_generation.py`**
   - `TutorialGenerationService` クラス
   - チュートリアル生成ロジック
   - AI統合サービスの呼び出し
   - サンプルステップ生成（デモ用）

3. **`apps/api/app/services/cloud_function_client.py`**
   - Cloud Function呼び出しクライアント
   - Veo3動画生成サービスとの連携
   - タイムアウトハンドリング（10分）

4. **`tests/integration/test_tutorial_endpoints.py`**
   - 統合テスト（13テストケース）
   - エラーハンドリングのテスト
   - 並行リクエストのテスト

### 主要なクラスと関数

#### TutorialGenerationService

```python
class TutorialGenerationService:
    async def generate_tutorial(
        self, style_id: str, customization_text: Optional[str] = None
    ) -> TutorialResponse:
        # チュートリアル生成のメインロジック
        # 現在はサンプルデータを返すデモ実装
```

#### CloudFunctionClient

```python
class CloudFunctionClient:
    async def generate_video(
        self, image_url: str, instruction_text: str
    ) -> str:
        # Cloud Function呼び出し
        # Veo3での動画生成（実際のデプロイ後に動作）
```

### エンドポイント仕様

- **パス**: `/api/tutorials/generate`
- **メソッド**: POST
- **リクエストボディ**:
  ```json
  {
    "style_id": "style_123",
    "customization_text": "アイメイクを重視"  // オプション
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": "tutorial_456",
    "title": "Professional Makeup Tutorial",
    "description": "Complete tutorial for style style_123",
    "total_steps": 5,
    "steps": [
      {
        "step_number": 1,
        "title": "スキンケアとベース準備",
        "description": "清潔な肌に保湿剤とプライマーを塗布します",
        "image_url": "https://storage.googleapis.com/...",
        "video_url": "https://storage.googleapis.com/...",
        "tools": ["保湿剤", "プライマー", "メイクスポンジ"]
      }
    ]
  }
  ```

## エラー対処

### 実装中に遭遇した問題と解決方法

1. **問題**: AsyncClientのテストフィクスチャーエラー
   - **解決**: `ASGITransport`を使用して適切に初期化

2. **問題**: エラーレスポンスフォーマットの不一致
   - **解決**: FastAPIの標準エラーフォーマットに合わせてテストを修正

3. **問題**: mypy型エラー（`MakeupStep.tools`属性）
   - **解決**: 正しい属性名`tools_needed`を使用

## 改善点

1. **実際のAI統合**: 現在はサンプルデータを返すため、実際のGemini/Veo3統合が必要
2. **キャッシング**: スタイル情報のメモリキャッシュまたはRedis導入
3. **非同期処理**: 長時間実行タスクのためのジョブキュー実装
4. **進捗通知**: WebSocketやServer-Sent Eventsによるリアルタイム進捗通知

## 開発者が実行する必要があること

### 新規エンドポイント

- **パス**: `/api/tutorials/generate`
- **メソッド**: POST
- **説明**: チュートリアル生成エンドポイント

### 環境変数（オプション）

`.env`ファイルに以下を追加可能（デフォルト値あり）:

```env
CLOUD_FUNCTION_URL=https://us-central1-ejan-minimum.cloudfunctions.net/generate-video
```

## 動作検証方法

### APIエンドポイントの動作確認

```bash
# HTTPieでのテスト
http POST localhost:8000/api/tutorials/generate \
  style_id="test_style_123" \
  customization_text="アイメイクを重視"

# curlでのテスト
curl -X POST "http://localhost:8000/api/tutorials/generate" \
  -H "Content-Type: application/json" \
  -d '{"style_id": "test_style_123", "customization_text": "アイメイクを重視"}'
```

### Swagger UIでのテスト

1. ブラウザで`http://localhost:8000/docs`を開く
2. `/api/tutorials/generate`エンドポイントを探す
3. "Try it out"をクリック
4. リクエストボディを入力して"Execute"をクリック

### Cloud Functions動作確認（デプロイ後）

```bash
# Cloud Functionsのログ確認
gcloud functions logs read generate-video --limit 50

# Health check
curl https://us-central1-ejan-minimum.cloudfunctions.net/generate-video
```

## テスト結果

- **テスト実行**: `uv run pytest tests/integration/test_tutorial_endpoints.py -v`
- **結果**: 13 passed, 2 warnings
- **カバレッジ**: エンドポイントの主要なパスをカバー

## TDD実装プロセス

1. **RED**: テストを先に作成し、失敗を確認
2. **GREEN**: 最小限の実装でテストをパス
3. **REFACTOR**: Cloud Function統合など機能を追加
4. **品質チェック**:
   - Black: コードフォーマット完了
   - Ruff: リンターエラー0
   - mypy: 型チェックパス
   - pytest: 全テストパス