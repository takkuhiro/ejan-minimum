# タスク6.1: API通信レイヤーの実装

## 概要
フロントエンドとバックエンドAPI間の通信を管理するクライアントライブラリを実装しました。TDD（Test-Driven Development）の手法を用いて、まずテストを作成し、その後実装を行いました。

## 実装詳細

### 主要ファイル
- `apps/web/lib/api/client.ts` - APIクライアントの実装
- `apps/web/lib/api/error-handler.ts` - エラーハンドリングユーティリティ
- `apps/web/types/api.ts` - TypeScript型定義
- `apps/web/tests/unit/api-client.test.ts` - ユニットテスト

### 主要機能

#### ApiClientクラス
- **generateStyles**: 写真から3つのメイクスタイルを生成
- **generateTutorial**: 選択したスタイルのチュートリアルを生成
- **getStyleDetail**: スタイルの詳細情報を取得

#### 機能的特徴
- 自動リトライ機能（指数バックオフ）
- タイムアウト処理（デフォルト4分）
- リクエストの中止機能（AbortController）
- 10MB画像サイズ制限の検証
- APIキー認証サポート

### テスト駆動開発プロセス
1. **RED Phase**: 最初に失敗するテストを16個作成
2. **GREEN Phase**: テストをパスする最小限の実装を作成
3. **REFACTOR Phase**: エラーハンドラーの分離とコードの最適化

## エラー対処

### ESLintバージョン問題
Next.js 14.2.16との互換性のため、ESLint v8にダウングレードする必要がありました。

### AbortSignalテスト
テストでAbortSignalがモック検証に含まれることを考慮し、`expect.objectContaining()`と`expect.any(AbortSignal)`を使用しました。

## 改善点
- レート制限の実装
- レスポンスキャッシング機能
- リクエストのデバッグログ
- WebSocketサポート（将来的なリアルタイム更新用）

## 開発者が実行する必要があること

### 新規ファイル作成
以下のファイルが新規作成されました：
- `apps/web/lib/api/client.ts`
- `apps/web/lib/api/error-handler.ts`
- `apps/web/types/api.ts`
- `apps/web/.env.local`
- `apps/web/.env.local.example`
- `apps/web/.eslintrc.json`
- `apps/web/jest.config.js`
- `apps/web/jest.setup.js`
- `apps/web/tests/unit/api-client.test.ts`

### 環境変数設定
`.env.local`ファイルにAPIエンドポイントを設定：
```env
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_STORAGE_URL=https://storage.googleapis.com
```

### パッケージの追加
以下のパッケージがインストールされました（package.jsonは自動更新済み）：
- Jest関連: jest, @testing-library/react, @testing-library/jest-dom
- ESLint関連: eslint@8, eslint-config-next@14
- Prettier: prettier

## 動作検証方法

### APIクライアントのテスト
```bash
cd apps/web
npm run test:ci  # すべてのテストを実行
```

### 使用例（React Component内）
```typescript
import { apiClient } from '@/lib/api/client';

// スタイル生成
const result = await apiClient.generateStyles({
  photo: base64Photo,
  gender: 'female'
});

if (result.success) {
  console.log(result.data.styles);
} else {
  console.error(result.error.message);
}
```

### ビルド確認
```bash
cd apps/web
npm run build  # TypeScriptコンパイルとNext.jsビルド
```

## テスト結果
すべてのテスト（16個）が成功しています：
- コンストラクタテスト: 2個
- generateStylesテスト: 4個
- generateTutorialテスト: 4個
- getStyleDetailテスト: 2個
- リクエストインターセプタテスト: 1個
- エラーハンドリングテスト: 2個
- 中止機能テスト: 1個

タスク6.1のAPI通信レイヤー実装が完了しました。